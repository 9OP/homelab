networks:
  homelab:
    driver: bridge

volumes:
  jellyfin_config:
    driver: local
  prowlarr_config:
    driver: local
  radarr_config:
    driver: local
  sonarr_config:
    driver: local

services:
  # Reverse proxy and web server
  # Handles HTTPS certificates and routes traffic to internal services
  # Access: http://torrent.vestige.internal, http://prowlarr.vestige.internal, etc.
  caddy:
    image: caddy:2.8.4-alpine
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./configs/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./site:/srv:ro
      - ./certs:/certs:ro
    networks: [homelab]
    security_opt:
      - no-new-privileges:true
    cap_drop: [ALL]
    cap_add:
      - NET_BIND_SERVICE
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:2019/config/ >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  # DNS server for custom internal domain resolution
  # Resolves *.vestige.internal domains to Tailscale IP
  # Used by Tailscale split DNS configuration
  dnsmasq:
    image: tobi312/tools:dnsmasq
    container_name: dnsmasq
    restart: unless-stopped
    ports:
      - "53:53/udp"
      - "53:53/tcp"
    environment:
      DNSMASQ_USER: root
    volumes:
      - ./configs/dnsmasq.conf:/etc/dnsmasq.conf:ro
    networks: [homelab]
    security_opt:
      - no-new-privileges:true
    cap_drop: [ALL]
    cap_add:
      - NET_BIND_SERVICE
      - SETGID
      - SETUID

  # BitTorrent client for downloading torrents
  # Downloads files sent by Radarr/Sonarr to /mnt/storage/downloads
  # Access: http://torrent.vestige.internal
  qbittorrent:
    image: linuxserver/qbittorrent:5.0.0
    container_name: qbittorrent
    restart: unless-stopped
    environment:
      PUID: 1000
      PGID: 1000
      TZ: Europe/Paris
      WEBUI_PORT: 8080
    ports:
      - "6881:6881/tcp"
      - "6881:6881/udp"
    volumes:
      - ./configs/qbittorrent.conf:/config/qBittorrent/qBittorrent.conf
      - /mnt/storage/downloads:/downloads
    networks: [homelab]
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080 >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Media server for streaming movies and TV shows
  # Reads media from /mnt/storage/media (movies and tv folders)
  # Access: https://media.vestige-lab.xyz (public) or internal via Tailscale
  jellyfin:
    image: linuxserver/jellyfin:10.10.3
    container_name: jellyfin
    restart: unless-stopped
    environment:
      PUID: 1000
      PGID: 1000
      TZ: Europe/Paris
    volumes:
      - jellyfin_config:/config
      - /mnt/storage/media:/media
    networks: [homelab]
    security_opt:
      - no-new-privileges:true
    cap_drop: [ALL]
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8096/health >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  # Indexer manager for torrent sites
  # Manages torrent indexers/trackers and syncs them to Radarr/Sonarr
  # Searches across multiple indexers for releases
  # Access: http://prowlarr.vestige.internal
  prowlarr:
    image: linuxserver/prowlarr:latest
    container_name: prowlarr
    restart: unless-stopped
    dns:
      - 8.8.8.8
      - 8.8.4.4
    environment:
      PUID: 1000
      PGID: 1000
      TZ: Europe/Paris
    volumes:
      - prowlarr_config:/config
    networks: [homelab]
    security_opt:
      - no-new-privileges:true
    cap_drop: [ALL]
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:9696/ping >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Movie collection manager
  # Automatically searches, downloads, and organizes movies
  # Sends torrents to qBittorrent and moves completed files to /mnt/storage/media/movies
  # Access: http://radarr.vestige.internal
  radarr:
    image: linuxserver/radarr:latest
    container_name: radarr
    restart: unless-stopped
    environment:
      PUID: 1000
      PGID: 1000
      TZ: Europe/Paris
    volumes:
      - radarr_config:/config
      - /mnt/storage/media/movies:/movies
      - /mnt/storage/downloads:/downloads
    networks: [homelab]
    security_opt:
      - no-new-privileges:true
    cap_drop: [ALL]
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:7878/ping >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Web-based file manager for browsing and managing server files
  # Access all storage, uploads, downloads, and media files via browser
  # Access: http://files.vestige.internal
  filebrowser:
    image: filebrowser/filebrowser:latest
    container_name: filebrowser
    restart: unless-stopped
    environment:
      PUID: 1000
      PGID: 1000
      TZ: Europe/Paris
    volumes:
      - /mnt/storage:/srv
      - ./configs/filebrowser.db:/database.db
    networks: [homelab]
    security_opt:
      - no-new-privileges:true
    cap_drop: [ALL]
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:80/health >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  # TV show collection manager
  # Automatically searches, downloads, and organizes TV series
  # Sends torrents to qBittorrent and moves completed files to /mnt/storage/media/tv
  # Access: http://sonarr.vestige.internal
  sonarr:
    image: linuxserver/sonarr:latest
    container_name: sonarr
    restart: unless-stopped
    environment:
      PUID: 1000
      PGID: 1000
      TZ: Europe/Paris
    volumes:
      - sonarr_config:/config
      - /mnt/storage/media/tv:/tv
      - /mnt/storage/downloads:/downloads
    networks: [homelab]
    security_opt:
      - no-new-privileges:true
    cap_drop: [ALL]
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8989/ping >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
